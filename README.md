# Android Studio项目工程搭建JNI环境

- 此工程初始化按照默认步骤即可,不需要勾选Include C++ support

- 配置jni环境,把ndk添加到环境变量中去,以win10为例:

  ```
  
  ANDROID_HOME:C:\Users\w1138\AppData\Local\Android\Sdk
  
  NDK_ROOT:%ANDROID_HOME%\ndk-bundle
  
  ```

  把 `%NDK_ROOT%` 添加到path中去,并如此`ndk-build.cmd -v`出现如下内容

  ```
  C:\Users\w1138>ndk-build.cmd -v
  GNU Make 3.81
  Copyright (C) 2006  Free Software Foundation, Inc.
  This is free software; see the source for copying conditions.
  There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A
  PARTICULAR PURPOSE.
  
  This program built for i686-w64-mingw32
  ```

  

- 在工程下面新建一个JNI目录,并创建`Android.mk`和`Application.mk`文件,如下如下:

  - Android.mk内容

    ```
    LOCAL_PATH:=$(call my-dir)
    include $(CLEAR_VARS)
    #libtestjni.so   //生成的so库名称
    LOCAL_MODULE := testjni  //java中调用加载的模块名称
    LOCAL_SRC_FILES := test.cpp  //指定的cpp文件
    LOCAL_LDLIBS := -llog     //log日志
    include $(BUILD_SHARED_LIBRARY)
    ```

  - Application.mk内容

    ```
    APP_PLATFORM := android-16   
    APP_ABI := all
    ```

- 在app下的build.gradle添加如下代码,并同步一下`sync now`

  ```
  sourceSets {
          main {
          	//表示生产的so文件所在路径在什么位置
              jniLibs.srcDirs = ['../libs']
          }
      }
  
      externalNativeBuild {
          ndkBuild {
              //表示构件androidJNI的Android.mk的所在路径
              path '../JNI/Android.mk'
          }
      }
  
      packagingOptions {//加上这些代码
          pickFirst 'lib/armeabi-v7a/libtestjni.so'
          pickFirst 'lib/armeabi-v8a/libtestjni.so'
          pickFirst 'lib/arm64-v8a/libtestjni.so'
          pickFirst 'lib/x86/libtestjni.so'
          pickFirst 'lib/x86_64/libtestjni.so'
      }
  ```

- 在JNI文件夹下创建一个test.cpp文件,复制如下内容,`#include <android/log.h>`打印日志所需要的头文件

  ```
  /* DO NOT EDIT THIS FILE - it is machine generated */
  #include <jni.h>
  #include <android/log.h>
  /* Header for class com_bupin_jnidemo_JniUtil */
  
  #ifndef _Included_com_bupin_jnidemo_JniUtil
  #define _Included_com_bupin_jnidemo_JniUtil
  #ifdef __cplusplus
  extern "C" {
  #endif
  
  JNIEXPORT void JNICALL Java_com_bupin_jnidemo_JniUtil_helloFromC(JNIEnv *env, jobject obj) {
      __android_log_print(ANDROID_LOG_INFO, "MainActivity", "JNI:hello jni");
  }
  
  #ifdef __cplusplus
  }
  #endif
  #endif
  ```

- 在工程下面的`Terminal`选项卡中进入到`JNI`目录下,执行`ndk-build.cmd`会在工程下lib文件生成so库

- java调用so文件

  - 在包里新建一个`JniUtil.java`文件,内容如下:

    ```
    package com.bupin.jnidemo;
    
    public class JniUtil {
    
        static {
        //LOCAL_MODULE := testjni 下面的加载名称对应上面Android.mk里的配置
            System.loadLibrary("testjni");
        }
        private static JniUtil mJniUtil = new JniUtil();
    
        private JniUtil() {
    
        }
    
        public static JniUtil getInstance() {
            return mJniUtil;
        }
    
        public native void helloFromC();
        public native int testInt(int a,int b);
        public native boolean testBoolean(boolean a);
        public native String testString(String s1,String s2);
        public native void testArray(int[] arr);
    
    }
    
    ```

  - 在下面的`Terminal`新建一个Local,并进入包名所在的目录下,以本工程为例:

    ```
    cd app/src/main/java
    ```

  - 进入包名下后,执行如下命令,此时会在java文件夹下生成一个`com_bupin_jnidemo_JniUtil.h`头文件

    ```
    javah -jni com.bupin.jnidemo.JniUtil
    ```

    `com_bupin_jnidemo_JniUtil.h`内容如下

    ```
    /* DO NOT EDIT THIS FILE - it is machine generated */
    #include <jni.h>
    /* Header for class com_bupin_jnidemo_JniUtil */
    
    #ifndef _Included_com_bupin_jnidemo_JniUtil
    #define _Included_com_bupin_jnidemo_JniUtil
    #ifdef __cplusplus
    extern "C" {
    #endif
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    helloFromC
     * Signature: ()V
     */
    JNIEXPORT void JNICALL Java_com_bupin_jnidemo_JniUtil_helloFromC
      (JNIEnv *, jobject);
    
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    testInt
     * Signature: (II)I
     */
    JNIEXPORT jint JNICALL Java_com_bupin_jnidemo_JniUtil_testInt
      (JNIEnv *, jobject, jint, jint);
    
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    testBoolean
     * Signature: (Z)Z
     */
    JNIEXPORT jboolean JNICALL Java_com_bupin_jnidemo_JniUtil_testBoolean
      (JNIEnv *, jobject, jboolean);
    
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    testString
     * Signature: (Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;
     */
    JNIEXPORT jstring JNICALL Java_com_bupin_jnidemo_JniUtil_testString
      (JNIEnv *, jobject, jstring, jstring);
    
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    testArray
     * Signature: ([I)V
     */
    JNIEXPORT void JNICALL Java_com_bupin_jnidemo_JniUtil_testArray
      (JNIEnv *, jobject, jintArray);
    
    #ifdef __cplusplus
    }
    #endif
    #endif
    
    ```

  - 将`com_bupin_jnidemo_JniUtil.h`声明的方法拷贝到`test.cpp`文件中,新的 `test.cpp`文件如下:

    ```
    /* DO NOT EDIT THIS FILE - it is machine generated */
    #include <jni.h>
    #include <android/log.h>
    /* Header for class com_bupin_jnidemo_JniUtil */
    
    #ifndef _Included_com_bupin_jnidemo_JniUtil
    #define _Included_com_bupin_jnidemo_JniUtil
    #ifdef __cplusplus
    extern "C" {
    #endif
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    helloFromC
     * Signature: ()V
     */
    JNIEXPORT void JNICALL Java_com_bupin_jnidemo_JniUtil_helloFromC(JNIEnv *env, jobject obj) {
        __android_log_print(ANDROID_LOG_INFO, "MainActivity", "JNI:hello jni");
    }
    
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    testInt
     * Signature: (II)I
     */
    JNIEXPORT jint JNICALL
    Java_com_bupin_jnidemo_JniUtil_testInt(JNIEnv *env, jobject obj, jint a, jint b) {
        int i1 = a;
        int i2 = b;
        __android_log_print(ANDROID_LOG_INFO, "MainActivity", "收到的数据:a=%d   b=%d", a, b);
        int c = a + b;
        return c;
    }
    
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    testBoolean
     * Signature: (Z)Z
     */
    JNIEXPORT jboolean JNICALL
    Java_com_bupin_jnidemo_JniUtil_testBoolean(JNIEnv *env, jobject obj, jboolean b) {
        int flag = (b == JNI_TRUE) ? 1 : 0;
        return (flag == 1) ? JNI_TRUE : JNI_FALSE;
    }
    
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    testString
     * Signature: (Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;
     */
    JNIEXPORT jstring JNICALL
    Java_com_bupin_jnidemo_JniUtil_testString(JNIEnv *env, jobject obj, jstring s1, jstring s2) {
        const char *str1 = NULL;
        const char *str2 = NULL;
        str1 = env->GetStringUTFChars(s1, 0);
        __android_log_print(ANDROID_LOG_INFO, "MainActivity", "before release JNI: str1 = %s", str1);
        //释放java传递过来jstring里面的在堆上开辟的字符串空间
        env->ReleaseStringUTFChars(s1, str1);
        //  __android_log_print(ANDROID_LOG_INFO, "MainActivity", "after release JNI: c_str1 = %s", str1);
    
        str2 = env->GetStringUTFChars(s2, 0);
        __android_log_print(ANDROID_LOG_INFO, "MainActivity", "before release JNI: str2 = %s", str2);
        //释放java传递过来jstring里面的在堆上开辟的字符串空间
        env->ReleaseStringUTFChars(s2, str2);
    
        jstring str = env->NewStringUTF("JNI return String:");
        return str;
    }
    
    /*
     * Class:     com_bupin_jnidemo_JniUtil
     * Method:    testArray
     * Signature: ([I)V
     */
    JNIEXPORT void JNICALL
    Java_com_bupin_jnidemo_JniUtil_testArray(JNIEnv *env, jobject obj, jintArray arr) {
        jint *p = env->GetIntArrayElements(arr, 0);
        jsize len = env->GetArrayLength(arr);
        __android_log_print(ANDROID_LOG_INFO, "MainActivity", "len=%d", len);
        for (int i = 0; i < len; i++) {
            __android_log_print(ANDROID_LOG_INFO, "MainActivity", "p[%d]=%d\n", i, p[i]);
        }
        env->ReleaseIntArrayElements(arr,p,0);
    }
    
    #ifdef __cplusplus
    }
    #endif
    #endif
    ```

  - 上面的`test.cpp`文件中的方法已经实现了,可以通过点击按钮来测试,在`Logcat`中以`MainActivity`来过滤